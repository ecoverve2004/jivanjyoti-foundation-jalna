// Enhanced AI Chat Widget Implementation
class ChatWidget {
    constructor() {
        this.isOpen = false;
        this.messages = [];
        this.userInfo = null;
        this.isRecording = false;
        this.mediaRecorder = null;
        this.audioChunks = [];
        this.unreadCount = 0;
        this.init();
    }

    init() {
        // Check if widget already exists
        if (document.querySelector('.chat-widget')) {
            this.bindEvents();
            this.loadWelcomeMessage();
            return;
        }
        
        this.createWidget();
        this.bindEvents();
        this.loadWelcomeMessage();
    }

    createWidget() {
        const widget = document.createElement('div');
        widget.className = 'chat-widget';
        widget.innerHTML = `
            <div class="chat-window" id="chatWindow">
                <div class="chat-header">
                    <div class="chat-avatar">
                        <i class="fas fa-leaf"></i>
                    </div>
                    <div class="chat-info">
                        <h3>JivanJyoti Assistant</h3>
                        <p id="statusText">Online ‚Ä¢ Ready to help!</p>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <!-- Messages will be added here -->
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <div class="input-actions">
                            <button class="voice-btn" id="voiceBtn" title="Voice message">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="file-btn" id="fileBtn" title="Attach file">
                                <i class="fas fa-paperclip"></i>
                            </button>
                        </div>
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
                        <button class="chat-send" id="chatSend">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <input type="file" id="fileInput" style="display: none" accept="image/*,.pdf,.doc,.docx,.txt">
                    <div class="emoji-picker" id="emojiPicker">
                        <!-- Emojis will be added here -->
                    </div>
                </div>
            </div>
            <button class="chat-toggle" id="chatToggle">
                <i class="fas fa-comments"></i>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
        `;
        document.body.appendChild(widget);
        this.initEmojis();
    }

    initEmojis() {
        const emojis = ['üòä', 'üëç', '‚ù§Ô∏è', 'üå±', 'üå≥', 'üåø', 'üíö', 'üôè', 'üëè', '‚ú®', 'üåç', '‚ôªÔ∏è'];
        const emojiPicker = document.getElementById('emojiPicker');
        
        if (!emojiPicker) return;
        
        emojis.forEach(emoji => {
            const btn = document.createElement('button');
            btn.className = 'emoji-btn';
            btn.textContent = emoji;
            btn.onclick = () => this.insertEmoji(emoji);
            emojiPicker.appendChild(btn);
        });
    }

    insertEmoji(emoji) {
        const input = document.getElementById('chatInput');
        if (input) {
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').classList.remove('active');
        }
    }

    bindEvents() {
        const toggle = document.getElementById('chatToggle');
        const input = document.getElementById('chatInput');
        const send = document.getElementById('chatSend');
        const voiceBtn = document.getElementById('voiceBtn');
        const fileBtn = document.getElementById('fileBtn');
        const fileInput = document.getElementById('fileInput');

        if (toggle) toggle.addEventListener('click', () => this.toggleChat());
        if (input) {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });
            input.addEventListener('input', () => this.handleTyping());
        }
        if (send) send.addEventListener('click', () => this.sendMessage());
        if (voiceBtn) voiceBtn.addEventListener('click', () => this.toggleVoiceRecording());
        if (fileBtn) fileBtn.addEventListener('click', () => fileInput.click());
        if (fileInput) fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
    }

    toggleChat() {
        const window = document.getElementById('chatWindow');
        const toggle = document.getElementById('chatToggle');
        
        if (!window || !toggle) return;
        
        this.isOpen = !this.isOpen;
        
        if (this.isOpen) {
            window.classList.add('active');
            toggle.classList.add('active');
            toggle.innerHTML = '<i class="fas fa-times"></i>';
            this.clearNotifications();
            this.trackEvent('chat_opened');
        } else {
            window.classList.remove('active');
            toggle.classList.remove('active');
            toggle.innerHTML = '<i class="fas fa-comments"></i><span class="notification-badge" id="notificationBadge" style="display: none;">0</span>';
        }
    }

    loadWelcomeMessage() {
        setTimeout(() => {
            const welcomeMsg = this.getPersonalizedWelcome();
            this.addMessage('bot', welcomeMsg, true);
            this.showQuickActions([
                'üå≥ ‡§µ‡•É‡§ï‡•ç‡§∑‡§æ‡§∞‡•ã‡§™‡§£ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä',
                'ü§ù ‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï ‡§¨‡§®‡•á‡§Ç',
                'üìû ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£',
                'üíö ‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç'
            ]);
        }, 1000);
    }

    getPersonalizedWelcome() {
        const hour = new Date().getHours();
        let greeting = '';
        
        if (hour < 12) {
            greeting = '‡§∏‡•Å‡§™‡•ç‡§∞‡§≠‡§æ‡§§! ‚òÄÔ∏è';
        } else if (hour < 17) {
            greeting = '‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞! üåû';
        } else {
            greeting = '‡§∂‡•Å‡§≠ ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ! üåÖ';
        }
        
        const welcomeMessages = [
            `${greeting} ‡§ú‡•Ä‡§µ‡§®‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø ‡§´‡§æ‡§â‡§Ç‡§°‡•á‡§∂‡§® ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§π‡•à! üå±<br><br>‡§Æ‡•à‡§Ç ‡§Ü‡§™‡§ï‡§æ AI ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§π‡•Ç‡§Ç‡•§ ‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£ ‡§∏‡§Ç‡§∞‡§ï‡•ç‡§∑‡§£ ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§≠‡•Ä ‡§™‡•Ç‡§õ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç!`,
            `${greeting} ‡§Æ‡•à‡§Ç ‡§ú‡•Ä‡§µ‡§®‡§ú‡•ç‡§Ø‡•ã‡§§‡§ø ‡§´‡§æ‡§â‡§Ç‡§°‡•á‡§∂‡§® ‡§ï‡§æ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§Ö‡§∏‡§ø‡§∏‡•ç‡§ü‡•á‡§Ç‡§ü ‡§π‡•Ç‡§Ç! ü§ñüå≥<br><br>‡§µ‡•É‡§ï‡•ç‡§∑‡§æ‡§∞‡•ã‡§™‡§£, ‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§æ, ‡§Ø‡§æ ‡§¶‡§æ‡§® ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ú‡§æ‡§®‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`,
            `${greeting} Welcome to JivanJyoti Foundation! üåç<br><br>I'm here to help you learn about our environmental conservation work. How can I assist you today?`
        ];
        
        return welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
    }

    sendMessage() {
        const input = document.getElementById('chatInput');
        if (!input) return;
        
        const message = input.value.trim();
        if (!message) return;
        
        this.addMessage('user', message);
        input.value = '';
        
        this.trackUserMessage(message);
        this.showTyping();
        
        setTimeout(() => {
            this.hideTyping();
            this.processMessage(message);
        }, 1500);
    }

    addMessage(sender, content, showActions = false, messageType = 'text') {
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${sender}`;
        
        const avatar = sender === 'bot' ? '<i class="fas fa-leaf"></i>' : '<i class="fas fa-user"></i>';
        const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        let messageContent = content;
        if (messageType === 'file') {
            messageContent = `<div class="file-preview">
                <i class="fas fa-file"></i>
                <span>${content}</span>
            </div>`;
        } else if (messageType === 'audio') {
            messageContent = `<audio controls style="max-width: 200px;">
                <source src="${content}" type="audio/webm">
                Your browser does not support audio playback.
            </audio>`;
        }
        
        messageDiv.innerHTML = `
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
                ${messageContent}
                <div class="message-time">${timestamp}</div>
            </div>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        this.messages.push({
            sender,
            content,
            messageType,
            timestamp: new Date().toISOString()
        });
        
        if (sender === 'bot' && !this.isOpen) {
            this.showNotification();
        }
    }

    showQuickActions(actions) {
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;
        
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message bot';
        
        const actionsHTML = actions.map((action, index) => 
            `<div class="quick-action" onclick="window.chatWidget.handleQuickAction('${action}')" style="animation-delay: ${index * 0.1}s">${action}</div>`
        ).join('');
        
        actionsDiv.innerHTML = `
            <div class="message-avatar"><i class="fas fa-leaf"></i></div>
            <div class="message-content">
                <p style="margin-bottom: 10px; font-size: 13px; color: #6b7280;">üí° Quick actions:</p>
                <div class="quick-actions">${actionsHTML}</div>
            </div>
        `;
        
        messagesContainer.appendChild(actionsDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    handleQuickAction(action) {
        this.addMessage('user', action);
        this.showTyping();
        
        const delay = Math.random() * 1000 + 800;
        
        setTimeout(() => {
            this.hideTyping();
            this.processMessage(action);
        }, delay);
    }

    processMessage(message) {
        const lowerMessage = message.toLowerCase();
        let response = '';
        
        if (lowerMessage.includes('program') || lowerMessage.includes('‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ')) {
            response = '‡§π‡§Æ‡§æ‡§∞‡•á ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ:<br>üå≥ ‡§µ‡•É‡§ï‡•ç‡§∑‡§æ‡§∞‡•ã‡§™‡§£ ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§® - 15,420+ ‡§™‡•á‡§°‡§º<br>üìö ‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£ ‡§∂‡§ø‡§ï‡•ç‡§∑‡§æ - 120+ ‡§∏‡•ç‡§ï‡•Ç‡§≤<br>‚ôªÔ∏è ‡§ï‡§ö‡§∞‡§æ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® - 50+ ‡§∏‡§Æ‡•Å‡§¶‡§æ‡§Ø<br>üíß ‡§ú‡§≤ ‡§∏‡§Ç‡§∞‡§ï‡•ç‡§∑‡§£ - 25+ ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ<br>üåæ ‡§ú‡•à‡§µ‡§ø‡§ï ‡§ñ‡•á‡§§‡•Ä - 200+ ‡§ï‡§ø‡§∏‡§æ‡§®<br><br>‡§ï‡•å‡§® ‡§∏‡§æ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Ü‡§™‡§ï‡•ã ‡§¶‡§ø‡§≤‡§ö‡§∏‡•ç‡§™ ‡§≤‡§ó‡§§‡§æ ‡§π‡•à?';
        } else if (lowerMessage.includes('tree') || lowerMessage.includes('plantation') || lowerMessage.includes('‡§µ‡•É‡§ï‡•ç‡§∑')) {
            response = '‡§π‡§Æ‡§æ‡§∞‡•á ‡§µ‡•É‡§ï‡•ç‡§∑‡§æ‡§∞‡•ã‡§™‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Æ‡•á‡§Ç 15,420+ ‡§™‡•á‡§°‡§º ‡§≤‡§ó‡§æ‡§è ‡§ó‡§è ‡§π‡•à‡§Ç! üå≥<br><br>‡§π‡§Æ ‡§®‡•Ä‡§Æ, ‡§¨‡§∞‡§ó‡§¶, ‡§™‡•Ä‡§™‡§≤ ‡§î‡§∞ ‡§Ü‡§Æ ‡§ú‡•à‡§∏‡•Ä ‡§¶‡•á‡§∂‡•Ä ‡§™‡•ç‡§∞‡§ú‡§æ‡§§‡§ø‡§Ø‡§æ‡§Ç ‡§≤‡§ó‡§æ‡§§‡•á ‡§π‡•à‡§Ç‡•§ ‡§™‡•ç‡§∞‡§§‡•ç‡§Ø‡•á‡§ï ‡§™‡•á‡§°‡§º ‡§ï‡•Ä ‡§≤‡§æ‡§ó‡§§ ‚Çπ50 ‡§π‡•à ‡§ú‡§ø‡§∏‡§Æ‡•á‡§Ç 2 ‡§∏‡§æ‡§≤ ‡§ï‡•Ä ‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§∂‡§æ‡§Æ‡§ø‡§≤ ‡§π‡•à‡•§<br><br>‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§™‡•á‡§°‡§º‡•ã‡§Ç ‡§ï‡•ã ‡§™‡•ç‡§∞‡§æ‡§Ø‡•ã‡§ú‡§ø‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?';
        } else if (lowerMessage.includes('volunteer') || lowerMessage.includes('join') || lowerMessage.includes('‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï')) {
            response = '‡§¨‡§π‡•Å‡§§ ‡§¨‡§¢‡§º‡§ø‡§Ø‡§æ! ‡§π‡§Æ ‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï‡•ã‡§Ç ‡§ï‡§æ ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§ï‡§∞‡§§‡•á ‡§π‡•à‡§Ç! üôå<br><br>‡§Ü‡§™ ‡§á‡§∏‡§Æ‡•á‡§Ç ‡§Æ‡§¶‡§¶ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:<br>‚Ä¢ ‡§µ‡•É‡§ï‡•ç‡§∑‡§æ‡§∞‡•ã‡§™‡§£ ‡§Ö‡§≠‡§ø‡§Ø‡§æ‡§®<br>‚Ä¢ ‡§∂‡•à‡§ï‡•ç‡§∑‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§∂‡§æ‡§≤‡§æ‡§è‡§Ç<br>‚Ä¢ ‡§∏‡§æ‡§Æ‡•Å‡§¶‡§æ‡§Ø‡§ø‡§ï ‡§™‡§π‡•Å‡§Ç‡§ö<br>‚Ä¢ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ ‡§Ü‡§Ø‡•ã‡§ú‡§®<br><br>‡§∂‡•Å‡§∞‡•Å‡§Ü‡§§ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡§æ ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§∏‡§æ‡§ù‡§æ ‡§ï‡§∞‡•á‡§Ç!';
        } else if (lowerMessage.includes('contact') || lowerMessage.includes('phone') || lowerMessage.includes('‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï')) {
            response = '‡§Ø‡§π‡§æ‡§Å ‡§π‡§Æ‡§æ‡§∞‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§π‡•à‡§Ç:<br><br>üìç At.Khodpuri Post.Utvad Tq.Dist.Jalna<br>üìû +91 957-777-1854<br>‚úâÔ∏è jivanjyoti@gmail.com<br><br>‡§ï‡§≠‡•Ä ‡§≠‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Ç‡§ï‡•ã‡§ö ‡§® ‡§ï‡§∞‡•á‡§Ç!';
        } else if (lowerMessage.includes('donate') || lowerMessage.includes('support') || lowerMessage.includes('‡§¶‡§æ‡§®')) {
            response = '‡§π‡§Æ‡§æ‡§∞‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üíö<br><br>‡§Ü‡§™ ‡§á‡§∏‡§ï‡•á ‡§Æ‡§æ‡§ß‡•ç‡§Ø‡§Æ ‡§∏‡•á ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§¶‡•á ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç:<br>‚Ä¢ ‡§µ‡•É‡§ï‡•ç‡§∑ ‡§™‡•ç‡§∞‡§æ‡§Ø‡•ã‡§ú‡§® (‚Çπ50/‡§™‡•á‡§°‡§º)<br>‚Ä¢ ‡§Æ‡§æ‡§∏‡§ø‡§ï ‡§¶‡§æ‡§®<br>‚Ä¢ ‡§â‡§™‡§ï‡§∞‡§£ ‡§¶‡§æ‡§®<br>‚Ä¢ ‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡•Ä ‡§∏‡§Æ‡§Ø<br><br>‡§π‡§∞ ‡§Ø‡•ã‡§ó‡§¶‡§æ‡§® ‡§∏‡•á ‡§´‡§∞‡•ç‡§ï ‡§™‡§°‡§º‡§§‡§æ ‡§π‡•à!';
        } else {
            response = '‡§Ü‡§™‡§ï‡•á ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üå±<br><br>‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§ü‡•Ä‡§Æ ‡§Ü‡§™‡§ï‡•Ä ‡§™‡•Ç‡§õ‡§§‡§æ‡§õ ‡§ï‡•Ä ‡§∏‡§Æ‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡•á‡§ó‡•Ä ‡§î‡§∞ ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§Ü‡§™‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§ó‡•Ä‡•§ ‡§ï‡•ç‡§Ø‡§æ ‡§π‡§Æ‡§æ‡§∞‡•á ‡§™‡§∞‡•ç‡§Ø‡§æ‡§µ‡§∞‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ‡•ã‡§Ç ‡§ï‡•á ‡§¨‡§æ‡§∞‡•á ‡§Æ‡•á‡§Ç ‡§ï‡•Å‡§õ ‡§ñ‡§æ‡§∏ ‡§ú‡§æ‡§®‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?';
            setTimeout(() => {
                this.showQuickActions([
                    'üå≥ ‡§µ‡•É‡§ï‡•ç‡§∑‡§æ‡§∞‡•ã‡§™‡§£ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä',
                    'ü§ù ‡§∏‡•ç‡§µ‡§Ø‡§Ç‡§∏‡•á‡§µ‡§ï ‡§¨‡§®‡•á‡§Ç',
                    'üìû ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç',
                    'üíö ‡§¶‡§æ‡§® ‡§ï‡§∞‡•á‡§Ç'
                ]);
            }, 1000);
        }
        
        this.addMessage('bot', response);
    }

    showTyping() {
        const messagesContainer = document.getElementById('chatMessages');
        if (!messagesContainer) return;
        
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message bot';
        typingDiv.id = 'typingIndicator';
        
        typingDiv.innerHTML = `
            <div class="message-avatar"><i class="fas fa-leaf"></i></div>
            <div class="message-content">
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        `;
        
        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    hideTyping() {
        const typing = document.getElementById('typingIndicator');
        if (typing) typing.remove();
    }

    showNotification() {
        this.unreadCount++;
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.textContent = this.unreadCount;
            badge.style.display = 'flex';
        }
    }

    clearNotifications() {
        this.unreadCount = 0;
        const badge = document.getElementById('notificationBadge');
        if (badge) {
            badge.style.display = 'none';
        }
    }

    handleTyping() {
        this.updateStatus('Typing...');
        clearTimeout(this.typingTimeout);
        this.typingTimeout = setTimeout(() => {
            this.updateStatus('Online ‚Ä¢ Ready to help!');
        }, 1000);
    }

    updateStatus(status) {
        const statusText = document.getElementById('statusText');
        if (statusText) {
            statusText.textContent = status;
        }
    }

    toggleVoiceRecording() {
        if (!this.isRecording) {
            this.startVoiceRecording();
        } else {
            this.stopVoiceRecording();
        }
    }

    async startVoiceRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.mediaRecorder = new MediaRecorder(stream);
            this.audioChunks = [];
            
            this.mediaRecorder.ondataavailable = (event) => {
                this.audioChunks.push(event.data);
            };
            
            this.mediaRecorder.onstop = () => {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                this.addMessage('user', audioUrl, false, 'audio');
                this.processVoiceMessage(audioBlob);
            };
            
            this.mediaRecorder.start();
            this.isRecording = true;
            
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                voiceBtn.classList.add('recording');
                voiceBtn.innerHTML = '<i class="fas fa-stop"></i>';
            }
            
            this.updateStatus('Recording...');
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            this.addMessage('bot', 'Sorry, I couldn\'t access your microphone. Please check your permissions.');
        }
    }

    stopVoiceRecording() {
        if (this.mediaRecorder && this.isRecording) {
            this.mediaRecorder.stop();
            this.mediaRecorder.stream.getTracks().forEach(track => track.stop());
            this.isRecording = false;
            
            const voiceBtn = document.getElementById('voiceBtn');
            if (voiceBtn) {
                voiceBtn.classList.remove('recording');
                voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            }
            
            this.updateStatus('Online ‚Ä¢ Ready to help!');
        }
    }

    processVoiceMessage(audioBlob) {
        this.showTyping();
        setTimeout(() => {
            this.hideTyping();
            this.addMessage('bot', '‡§Æ‡•à‡§Ç‡§®‡•á ‡§Ü‡§™‡§ï‡§æ ‡§µ‡•â‡§á‡§∏ ‡§Æ‡•à‡§∏‡•á‡§ú ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§ø‡§Ø‡§æ! üé§ ‡§π‡§Æ‡§æ‡§∞‡•Ä ‡§ü‡•Ä‡§Æ ‡§á‡§∏‡•á ‡§∏‡•Å‡§®‡•á‡§ó‡•Ä ‡§î‡§∞ ‡§ú‡§≤‡•ç‡§¶ ‡§π‡•Ä ‡§ú‡§µ‡§æ‡§¨ ‡§¶‡•á‡§ó‡•Ä‡•§ ‡§§‡•á‡§ú‡§º ‡§ú‡§µ‡§æ‡§¨ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ü‡§™ ‡§ü‡§æ‡§á‡§™ ‡§≠‡•Ä ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç‡•§');
        }, 2000);
    }

    handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const maxSize = 5 * 1024 * 1024; // 5MB
        if (file.size > maxSize) {
            this.addMessage('bot', 'File size should be less than 5MB. Please choose a smaller file.');
            return;
        }
        
        const allowedTypes = ['image/', 'application/pdf', 'text/', '.doc', '.docx'];
        const isAllowed = allowedTypes.some(type => file.type.includes(type) || file.name.includes(type));
        
        if (!isAllowed) {
            this.addMessage('bot', 'Please upload images, PDF, or document files only.');
            return;
        }
        
        this.addMessage('user', file.name, false, 'file');
        this.processFileUpload(file);
    }

    processFileUpload(file) {
        this.showTyping();
        setTimeout(() => {
            this.hideTyping();
            if (file.type.includes('image/')) {
                this.addMessage('bot', 'Thanks for sharing the image! üì∏ Our team will review it and get back to you. How can we help you with this?');
            } else {
                this.addMessage('bot', `Thanks for sharing "${file.name}"! üìÑ Our team will review the document and respond accordingly.`);
            }
        }, 1500);
    }

    trackEvent(event) {
        const data = {
            event: event,
            timestamp: new Date().toISOString(),
            page: window.location.pathname,
            userAgent: navigator.userAgent
        };
        
        console.log('Chat Event:', data);
    }

    trackUserMessage(message) {
        const data = {
            type: 'user_message',
            message: message,
            timestamp: new Date().toISOString(),
            page: window.location.pathname,
            sessionId: this.getSessionId()
        };
        
        console.log('User Message:', data);
        this.storeUserInquiry(data);
    }

    storeUserInquiry(data) {
        let inquiries = JSON.parse(localStorage.getItem('chatInquiries') || '[]');
        inquiries.push(data);
        localStorage.setItem('chatInquiries', JSON.stringify(inquiries));
    }

    getSessionId() {
        let sessionId = localStorage.getItem('chatSessionId');
        if (!sessionId) {
            sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('chatSessionId', sessionId);
        }
        return sessionId;
    }
}

// Initialize chat widget when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.chatWidget === 'undefined') {
        window.chatWidget = new ChatWidget();
    }
});